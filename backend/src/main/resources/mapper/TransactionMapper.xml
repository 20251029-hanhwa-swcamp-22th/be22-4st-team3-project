<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycompany._thstudy.transaction.query.mapper.TransactionMapper">

    <select id="findByFilter"
            resultType="com.mycompany._thstudy.transaction.query.dto.response.TransactionListResponse">
        /* TransactionMapper.findByFilter */
        SELECT
            t.id,
            t.type,
            t.category_id AS categoryId,
            c.name AS categoryName,
            t.amount,
            t.description,
            t.transaction_date AS transactionDate
        FROM transactions t
        JOIN categories c ON t.category_id = c.id
        JOIN users u ON t.user_id = u.id
        <where>
            u.email = #{userEmail}
            <if test="req.startDate != null">
                AND t.transaction_date >= #{req.startDate}
            </if>
            <if test="req.endDate != null">
                AND t.transaction_date &lt;= #{req.endDate}
            </if>
            <if test="req.type != null and req.type != ''">
                AND t.type = #{req.type}
            </if>
            <if test="req.categoryId != null">
                AND t.category_id = #{req.categoryId}
            </if>
            <if test="req.keyword != null and req.keyword != ''">
                AND t.description LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.minAmount != null">
                AND t.amount >= #{req.minAmount}
            </if>
            <if test="req.maxAmount != null">
                AND t.amount &lt;= #{req.maxAmount}
            </if>
        </where>
        ORDER BY t.transaction_date DESC, t.id DESC
    </select>

    <select id="findMonthlySummary"
            resultType="com.mycompany._thstudy.transaction.query.dto.response.CategoryRawSummary">
        SELECT c.name AS categoryName, t.type, SUM(t.amount) AS amount
        FROM transactions t
                 JOIN categories c ON t.category_id = c.id
                 JOIN users u ON t.user_id = u.id
        WHERE u.email = #{userEmail}
          AND YEAR(t.transaction_date) = #{year}
          AND MONTH(t.transaction_date) = #{month}
        GROUP BY c.name, t.type
        ORDER BY t.type, amount DESC
    </select>

    <select id="findDailySummary"
            resultType="com.mycompany._thstudy.transaction.query.dto.response.DailySummaryResponse">
        SELECT
            t.transaction_date AS transactionDate,
            SUM(CASE WHEN t.type = 'INCOME'  THEN t.amount ELSE 0 END) AS totalIncome,
            SUM(CASE WHEN t.type = 'EXPENSE' THEN t.amount ELSE 0 END) AS totalExpense
        FROM transactions t
                 JOIN users u ON t.user_id = u.id
        WHERE u.email = #{userEmail}
          AND YEAR(t.transaction_date)  = #{year}
          AND MONTH(t.transaction_date) = #{month}
        GROUP BY t.transaction_date
        ORDER BY t.transaction_date ASC
    </select>

    <select id="findRecentByUserEmail"
            resultType="com.mycompany._thstudy.transaction.query.dto.response.TransactionListResponse">
        SELECT
            t.id,
            t.type,
            t.category_id AS categoryId,
            c.name AS categoryName,
            t.amount,
            t.description,
            t.transaction_date AS transactionDate
        FROM transactions t
                 JOIN categories c ON t.category_id = c.id
                 JOIN users u ON t.user_id = u.id
        WHERE u.email = #{userEmail}
        ORDER BY t.transaction_date DESC, t.id DESC
        LIMIT 5
    </select>

</mapper>
